<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéÆ –ö–∞–∑–∏–Ω–æ | Supabase</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="container screen active" id="loginScreen">
        <div class="login-card glass">
            <h1>üé∞ –ö–∞–∑–∏–Ω–æ –Ω–∞ Supabase</h1>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchTab('login')">–í—Ö–æ–¥</button>
                <button class="tab-btn" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <div id="loginForm" class="form-container">
                <div class="input-group">
                    <label>–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
                
                <div class="test-credentials">
                    <p>–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:</p>
                    <p><strong>–ê–¥–º–∏–Ω:</strong> admin / admin123</p>
                    <p><strong>–ò–≥—Ä–æ–∫:</strong> player / player123</p>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div id="registerForm" class="form-container" style="display: none;">
                <div class="input-group">
                    <label>–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="registerUsername" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="registerPassword" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                </div>
                <div class="input-group">
                    <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="input-group">
                    <label>–ò–º—è:</label>
                    <input type="text" id="registerName" placeholder="–í–∞—à–µ –∏–º—è">
                </div>
                <button class="btn btn-primary" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–≥—Ä–æ–∫–∞ -->
    <div class="container screen" id="mainScreen">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header glass">
            <div class="user-avatar">
                <div class="avatar-placeholder" id="userAvatar">üë§</div>
            </div>
            <div class="user-name" id="userName">–ò–≥—Ä–æ–∫</div>
            <div class="user-id" id="userId">ID: ---</div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –±–∞–ª–∞–Ω—Å–∞ -->
        <div class="balance-card glass">
            <div class="balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-amount">
                <span id="balanceAmount">0</span>
                <div class="coin-icon">ü™ô</div>
            </div>
            <div class="balance-actions">
                <button class="btn-small" onclick="addTestCoins()">+1000 –º–æ–Ω–µ—Ç</button>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="actions-grid">
            <button class="btn btn-primary" onclick="showScreen('games')">
                <div class="btn-icon">üéÆ</div>
                <div class="btn-text">–ò–≥—Ä—ã</div>
            </button>

            <button class="btn btn-secondary" onclick="showScreen('transfer')">
                <div class="btn-icon">üí∏</div>
                <div class="btn-text">–ü–µ—Ä–µ–≤–æ–¥</div>
            </button>

            <button class="btn btn-secondary" onclick="showScreen('history')">
                <div class="btn-icon">üìä</div>
                <div class="btn-text">–ò—Å—Ç–æ—Ä–∏—è</div>
            </button>

            <button class="btn btn-secondary" onclick="showScreen('admin')" id="adminBtn" style="display: none">
                <div class="btn-icon">‚öôÔ∏è</div>
                <div class="btn-text">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            </button>
            
            <button class="btn btn-danger" onclick="logout()">
                <div class="btn-icon">üö™</div>
                <div class="btn-text">–í—ã–π—Ç–∏</div>
            </button>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ) -->
    <div class="container screen" id="gamesScreen">
        <!-- –¢—É—Ç –≤–∞—à–∏ –∏–≥—Ä—ã -->
    </div>

    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
    <div class="container screen" id="adminScreen">
        <div class="admin-card glass">
            <h2 class="game-title">‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            
            <div class="admin-section">
                <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                <div class="admin-controls">
                    <button class="btn btn-primary" onclick="loadAllUsers()">
                        <div class="btn-icon">üîÑ</div>
                        <div class="btn-text">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</div>
                    </button>
                    
                    <div class="user-list" id="userList">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
                    </div>
                    
                    <div class="user-edit" id="userEditForm" style="display: none;">
                        <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
                        <div class="input-group">
                            <label>ID:</label>
                            <input type="text" id="editUserId" readonly>
                        </div>
                        <div class="input-group">
                            <label>–õ–æ–≥–∏–Ω:</label>
                            <input type="text" id="editUsername">
                        </div>
                        <div class="input-group">
                            <label>–ò–º—è:</label>
                            <input type="text" id="editName">
                        </div>
                        <div class="input-group">
                            <label>–ë–∞–ª–∞–Ω—Å:</label>
                            <input type="number" id="editBalance">
                        </div>
                        <div class="input-group">
                            <label>–†–æ–ª—å:</label>
                            <select id="editRole">
                                <option value="user">–ò–≥—Ä–æ–∫</option>
                                <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                            </select>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="saveUserChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button class="btn btn-danger" onclick="deleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn btn-secondary" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="admin-section">
                <h3>üí∞ –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
                <div class="quick-add">
                    <div class="input-group">
                        <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                        <input type="text" id="quickUserId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    </div>
                    <div class="input-group">
                        <label>–°—É–º–º–∞:</label>
                        <input type="number" id="quickAmount" value="1000">
                    </div>
                    <button class="btn btn-primary" onclick="adminAddCoins()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                </div>
            </div>
            
            <div class="admin-section">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        <div class="stat-value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                        <div class="stat-value" id="totalBalance">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –∏–≥—Ä</div>
                        <div class="stat-value" id="totalGames">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ê–¥–º–∏–Ω–æ–≤</div>
                        <div class="stat-value" id="totalAdmins">0</div>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="showScreen('main')">
                    <div class="btn-icon">‚Üê</div>
                    <div class="btn-text">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</div>
                </button>
                <button class="btn btn-primary" onclick="loadAdminData()">
                    <div class="btn-icon">üìä</div>
                    <div class="btn-text">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</div>
                </button>
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø–µ—Ä–µ–≤–æ–¥–∞ -->
    <div class="container screen" id="transferScreen">
        <div class="game-card glass">
            <h2 class="game-title">üí∏ –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2>
            <div style="padding: 20px">
                <div style="margin-bottom: 20px">
                    <label style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.7);">
                        –õ–æ–≥–∏–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è:
                    </label>
                    <input type="text" id="friendUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥—Ä—É–≥–∞">
                </div>

                <div style="margin-bottom: 20px">
                    <label style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.7);">
                        –°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:
                    </label>
                    <input type="number" id="transferAmount" value="100" min="10">
                </div>

                <button class="btn btn-primary" onclick="makeTransfer()" style="width: 100%">
                    <div class="btn-text">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</div>
                </button>
            </div>
        </div>

        <button class="btn btn-secondary" onclick="showScreen('main')" style="margin-top: 20px">
            <div class="btn-icon">‚Üê</div>
            <div class="btn-text">–ù–∞–∑–∞–¥</div>
        </button>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
    <script src="supabase-auth.js"></script> <!-- –ù–û–í–´–ô –§–ê–ô–õ -->
    <script src="games.js"></script>
    <script src="app.js"></script>
    <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    window.loadAllUsers = async function() {
        try {
            const users = await window.supabaseAuth.getAllUsers();
            const userList = document.getElementById('userList');
            
            if (!users || users.length === 0) {
                userList.innerHTML = '<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            let html = '<div class="users-header">';
            html += '<div class="user-row header">';
            html += '<div>ID</div><div>–õ–æ–≥–∏–Ω</div><div>–ò–º—è</div><div>–ë–∞–ª–∞–Ω—Å</div><div>–†–æ–ª—å</div><div>–î–µ–π—Å—Ç–≤–∏—è</div>';
            html += '</div>';
            
            users.forEach(user => {
                html += `
                    <div class="user-row" data-user-id="${user.id}">
                        <div class="user-id-short">${user.id.substring(0, 8)}...</div>
                        <div>${user.username}</div>
                        <div>${user.name || '-'}</div>
                        <div>${user.balance} ü™ô</div>
                        <div><span class="role-badge ${user.role}">${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ò–≥—Ä–æ–∫'}</span></div>
                        <div>
                            <button class="btn-small" onclick="editUser('${user.id}')">‚úèÔ∏è</button>
                            <button class="btn-small btn-danger" onclick="confirmDeleteUser('${user.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            userList.innerHTML = html;
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message, 'error');
        }
    };
    
    window.editUser = async function(userId) {
        try {
            const users = await window.supabaseAuth.getAllUsers();
            const user = users.find(u => u.id === userId);
            
            if (!user) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editName').value = user.name || '';
            document.getElementById('editBalance').value = user.balance;
            document.getElementById('editRole').value = user.role;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('userEditForm').style.display = 'block';
            
        } catch (error) {
            showNotification(error.message, 'error');
        }
    };
    
    window.saveUserChanges = async function() {
        const userId = document.getElementById('editUserId').value;
        const username = document.getElementById('editUsername').value.trim();
        const name = document.getElementById('editName').value.trim();
        const balance = parseInt(document.getElementById('editBalance').value);
        const role = document.getElementById('editRole').value;
        
        if (!username) {
            showNotification('–õ–æ–≥–∏–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
            return;
        }
        
        try {
            await window.supabaseAuth.updateUser(userId, {
                username,
                name,
                balance,
                role
            });
            
            showNotification('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            cancelEdit();
            loadAllUsers();
            
        } catch (error) {
            showNotification(error.message, 'error');
        }
    };
    
    window.confirmDeleteUser = function(userId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –í—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
            deleteUser(userId);
        }
    };
    
    window.deleteUser = async function() {
        const userId = document.getElementById('editUserId').value;
        
        try {
            await window.supabaseAuth.deleteUser(userId);
            showNotification('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω', 'success');
            cancelEdit();
            loadAllUsers();
            
        } catch (error) {
            showNotification(error.message, 'error');
        }
    };
    
    window.cancelEdit = function() {
        document.getElementById('userEditForm').style.display = 'none';
    };
    
    window.adminAddCoins = async function() {
        const userId = document.getElementById('quickUserId').value.trim();
        const amount = parseInt(document.getElementById('quickAmount').value);
        
        if (!userId || !amount || amount <= 0) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'error');
            return;
        }
        
        try {
            const result = await window.supabaseAuth.addCoins(userId, amount);
            showNotification(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${amount} –º–æ–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${result.username}`, 'success');
            document.getElementById('quickUserId').value = '';
            document.getElementById('quickAmount').value = '1000';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
            if (window.loadAllUsers) {
                loadAllUsers();
            }
            
        } catch (error) {
            showNotification(error.message, 'error');
        }
    };
    
    window.loadAdminData = async function() {
        try {
            const stats = await window.supabaseAuth.getStats();
            
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            document.getElementById('totalBalance').textContent = stats.totalBalance;
            document.getElementById('totalGames').textContent = stats.totalGames;
            document.getElementById('totalAdmins').textContent = stats.totalAdmins;
            
            showNotification('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'error');
        }
    };
</script>
</body>
</html>